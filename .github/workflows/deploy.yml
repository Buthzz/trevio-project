name: Deploy to Development

on:
  push:
    branches:
      - development

env:
  DEPLOY_PATH: /home/trevio/htdocs/trevio.mfjrxn.eu.org
  APP_ENV: development

jobs:
  deploy:
    name: Deploy to CloudPanel VPS
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 10m
          script: |
            set -e  # Exit immediately on error
            
            echo "========================================="
            echo "üöÄ Deployment Started"
            echo "Time: $(date)"
            echo "Branch: development"
            echo "========================================="
            
            # ==========================================
            # 1. Pre-deployment Checks
            # ==========================================
            echo "üìã Running pre-deployment checks..."
            
            if [ ! -d "${{ env.DEPLOY_PATH }}" ]; then
              echo "‚ùå Deployment directory not found!"
              exit 1
            fi
            
            cd ${{ env.DEPLOY_PATH }}
            
            # ==========================================
            # 2. Git Operations
            # ==========================================
            echo "üì• Fetching latest changes from GitHub..."
            
            git config --global --add safe.directory ${{ env.DEPLOY_PATH }}
            git config core.filemode false
            
            # Store current commit for rollback
            CURRENT_COMMIT=$(git rev-parse HEAD)
            echo "Current commit: $CURRENT_COMMIT"
            
            # Fetch and reset
            git fetch origin development
            git reset --hard origin/development
            git clean -fd
            
            NEW_COMMIT=$(git rev-parse HEAD)
            echo "New commit: $NEW_COMMIT"
            
            # ==========================================
            # 3. Dependency Management
            # ==========================================
            echo "üì¶ Managing dependencies..."
            
            # Composer
            if [ -f "composer.json" ]; then
              echo "Installing Composer dependencies..."
              composer install \
                --no-dev \
                --no-interaction \
                --prefer-dist \
                --optimize-autoloader \
                --no-progress \
                --no-suggest 2>&1 | grep -v "Generating optimized autoload files"
            fi
            
            # NPM (only if needed)
            if [ -f "package.json" ]; then
              echo "Installing NPM dependencies..."
              npm ci --production --silent
              
              # Build assets if needed
              if [ -f "tailwind.config.js" ]; then
                echo "Building Tailwind CSS..."
                npm run build --if-present
              fi
            fi
            
            # ==========================================
            # 4. Application Maintenance
            # ==========================================
            echo "üîß Running maintenance tasks..."
            
            # Clear application cache
            if [ -d "cache" ]; then
              rm -rf cache/*
              echo "‚úÖ Cache cleared"
            fi
            
            # Clear logs older than 7 days (optional)
            if [ -d "logs" ]; then
              find logs/ -name "*.log" -mtime +7 -delete 2>/dev/null || true
              echo "‚úÖ Old logs cleaned"
            fi
            
            # ==========================================
            # 5. Security & Permissions
            # ==========================================
            echo "üîí Setting secure permissions..."
            
            # Directories: 755 (rwxr-xr-x)
            find ${{ env.DEPLOY_PATH }} -type d -exec chmod 755 {} \;
            
            # Files: 644 (rw-r--r--)
            find ${{ env.DEPLOY_PATH }} -type f -exec chmod 644 {} \;
            
            # Writable directories: 777 (rwxrwxrwx)
            chmod -R 777 logs/ 2>/dev/null || true
            chmod -R 777 cache/ 2>/dev/null || true
            chmod -R 777 public/uploads/ 2>/dev/null || true
            
            # Protect sensitive files
            chmod 600 .env 2>/dev/null || true
            chmod 600 config/*.php 2>/dev/null || true
            
            # ==========================================
            # 6. Health Check
            # ==========================================
            echo "üè• Running health check..."
            
            # Wait for app to be ready
            sleep 2
            
            # Check if site is reachable (optional, requires curl)
            if command -v curl &> /dev/null; then
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://trevio.mfjrxn.eu.org || echo "000")
              
              if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 301 ] || [ "$HTTP_CODE" -eq 302 ]; then
                echo "‚úÖ Health check passed (HTTP $HTTP_CODE)"
              else
                echo "‚ö†Ô∏è  Warning: Health check returned HTTP $HTTP_CODE"
                # Don't fail deployment on health check failure
                # Uncomment below to enable auto-rollback
                # echo "Rolling back to $CURRENT_COMMIT..."
                # git reset --hard $CURRENT_COMMIT
                # exit 1
              fi
            fi
            
            # ==========================================
            # 7. Post-deployment Summary
            # ==========================================
            echo "========================================="
            echo "‚úÖ Deployment Completed Successfully!"
            echo "Environment: ${{ env.APP_ENV }}"
            echo "Commit: $NEW_COMMIT"
            echo "Time: $(date)"
            echo "üåê Site: https://trevio.mfjrxn.eu.org"
            echo "========================================="
      
      - name: Notify on Failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed! Check logs above."
          # Add notification here (Slack, Discord, Email, etc)
